<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APUSH Unit 5 Clicker</title>
  <style>
    :root {
      --bg:#0b1220; --card:#111a2e; --muted:#a9b5d9; --text:#eef1fb;
      --accent:#7aa2ff; --accent-2:#66e3c4; --danger:#ff7a7a; --gold:#ffd166;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      --target-size:56px; --target-pad:10px; --move-ms:260ms;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1000px 600px at 15% 10%, #0f1830 0%, var(--bg) 50%),
        radial-gradient(800px 500px at 85% 20%, #0c1a33 0%, var(--bg) 50%);
      color:var(--text);
      font:16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px}
    h1{font-size:28px;margin:0}.subtitle{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1.4fr .9fr .7fr;gap:16px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:16px}

    /* Click Area */
    .click-area{
      position:relative;
      width:100%;
      aspect-ratio:1/1;
      border-radius:24px;
      background:
        radial-gradient(200px 200px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg,#1a2a53,#121d3a);
      box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 2px rgba(255,255,255,.06);
      overflow:hidden;
    }

    /* Moving Target */
    .target{
      position:absolute;
      width:var(--target-size);
      height:var(--target-size);
      border-radius:50%;
      background:
        radial-gradient(140% 140% at 30% 25%,
          rgba(255,255,255,.35) 0%,
          rgba(255,255,255,.16) 36%,
          rgba(255,255,255,.08) 58%,
          rgba(255,255,255,0) 78%),
        linear-gradient(180deg,#7aa2ff,#4f7ef0);
      background-clip:padding-box;
      color:#0b1124;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:
        left var(--move-ms) cubic-bezier(.2,.8,.2,1),
        top var(--move-ms) cubic-bezier(.2,.8,.2,1),
        transform .06s ease,
        filter .15s ease;
      box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.22);
    }
    .target:hover{filter:brightness(1.08)}
    .target:active{transform:scale(.97)}

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.1);
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:13px;color:var(--muted)
    }
    .pill strong{color:var(--text)}
    .btn{
      border:none;border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      transition:filter .15s, transform .06s;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.gold{background:linear-gradient(180deg,#f7d36f,#d8aa39);color:#281a00}
    .btn.accent{background:linear-gradient(180deg,#7aa2ff,#4f7ef0);color:#0c1330}
    .btn.alt{background:linear-gradient(180deg,#66e3c4,#35c2a2);color:#06241b}
    .btn.small-btn{padding:6px 8px;font-size:11px;border-radius:999px}

    .list{display:flex;flex-direction:column;gap:10px}
    .money{font-size:24px;font-weight:900}
    .small{font-size:12px;color:var(--muted)}

    .meter{height:10px;width:100%;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .meter>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    dialog{border:none;border-radius:18px;width:min(620px,92%);background:var(--card);color:var(--text);box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(5,10,20,.6)}
    .modal-head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px}

    .choices{display:grid;gap:10px;margin-top:10px}
    .choice{
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;color:var(--text);
      transition:background .15s,border-color .15s,transform .05s;
    }
    .choice:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.28);transform:translateY(-1px)}
    .choice.correct{border-color:var(--accent-2);background:rgba(102,227,196,.15)}
    .choice.wrong{border-color:var(--danger);background:rgba(255,122,122,.12)}

    /* Producer skill tree */
    .producer-tier{
      margin-bottom:16px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.08);
    }
    .producer-tier-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .producer-tier-header .title{font-size:13px;font-weight:600}
    .producer-tier-header .status{font-size:11px}
    .producer-tier-header .status.unlocked{color:#a5f3fc}
    .producer-tier-header .status.locked{color:#fca5a5}

    .node-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
      align-items:stretch;
    }
    .node{
      text-align:left;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .node-title{font-size:13px;margin-bottom:4px}
    .node-note{font-size:11px;color:var(--muted);margin-bottom:6px;min-height:34px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>APUSH Unit 5 Clicker</h1>
      <div class="subtitle">Earn <strong>USD</strong> by clicking, buying upgrades, and answering Unit 5 questions (1844‚Äì1877).</div>
    </div>
    <div class="row">
      <button id="saveBtn" class="btn alt">üíæ Save</button>
      <button id="prestigeBtn" class="btn gold">üåÄ Prestige</button>
    </div>
  </header>

  <div class="grid">
    <!-- Clicker -->
    <section class="card">
      <div class="head">
        <div class="row">
          <div>
            <div id="currency" class="money">$0</div>
            <div class="subtitle">Dollars</div>
          </div>
          <div class="pill"><span>üñ±Ô∏è $/Click:</span><strong id="ppc">1</strong></div>
          <div class="pill"><span>‚è±Ô∏è $/s:</span><strong id="pps">0</strong></div>
          <div class="pill"><span>‚ö° Mult:</span><strong id="mult">1√ó</strong></div>
          <div class="pill"><span>‚ú® Prestige:</span><strong id="prestige">0 pts (√ó1)</strong></div>
        </div>
      </div>
      <div class="body">
        <div id="clickArea" class="click-area">
          <button id="targetBtn" class="target" aria-label="Click for money">$</button>
        </div>
        <p class="small" style="margin-top:10px;">Click the moving target to earn money.</p>
        <div class="row" style="margin-top:10px;">
          <button id="boostBtn" class="btn gold">üéÅ Quiz Boost</button>
          <span id="boostTimer" class="pill">‚è≥ Boost: <strong>‚Äî</strong></span>
        </div>
        <div style="margin-top:10px;">
          <div class="meter"><div id="progressBar"></div></div>
          <div class="small muted" id="nextGoal">Goal: Reach $100,000,000</div>
        </div>
      </div>
    </section>

    <!-- Upgrades -->
    <section class="card">
      <div class="head"><strong>Upgrades</strong></div>
      <div class="body">
        <div id="upgradeList" class="list"></div>
      </div>
    </section>

    <!-- Producers summary / open tree -->
    <section class="card">
      <div class="head"><strong>Producers</strong></div>
      <div class="body">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="small">Passive income: <span id="producerPps">$0.00</span> /s</div>
          <button id="openProducerTree" class="btn">Open Producer Tree</button>
        </div>
        <div class="small">Unlock tiers with prestige points, then buy producers inside the skill tree.</div>
      </div>
    </section>
  </div>
</div>

<!-- Quiz Modal -->
<dialog id="quizModal" aria-labelledby="quizTitle" aria-describedby="quizDesc">
  <div class="modal-head">
    <strong id="quizTitle">Answer a Unit 5 question</strong>
    <button id="closeQuiz" class="btn">‚úñ</button>
  </div>
  <div class="modal-body">
    <div id="quizDesc" class="small">Get the answer right to pick a reward.</div>
    <h3 id="qText" style="margin:.6em 0 .4em"></h3>
    <div id="qChoices" class="choices" role="list"></div>
    <div class="footer" style="margin-top:10px;text-align:right;">
      <button id="rerollBtn" class="btn alt">üîÅ New Question</button>
    </div>
  </div>
</dialog>

<!-- Producer Skill Tree Modal -->
<dialog id="producerModal" aria-labelledby="producerTitle" aria-describedby="producerDesc">
  <div class="modal-head">
    <strong id="producerTitle">Producer Skill Tree</strong>
    <button id="closeProducerModal" class="btn">‚úñ</button>
  </div>
  <div class="modal-body">
    <div id="producerDesc" class="small" style="margin-bottom:8px;">
      Spend prestige points to unlock new tiers. Each tier contains producers that add passive income (PPS).
    </div>
    <div id="producerTree"></div>
  </div>
</dialog>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  const STORAGE_OK = (() => {
    try{
      const t='__apush5__';
      localStorage.setItem(t,'1');
      localStorage.removeItem(t);
      return true;
    }catch(_){ return false; }
  })();

  const BASE_TARGET_SIZE = 56;
  const SAVE_KEY = 'apush5-save-v4';
  const SCHEMA   = 4;

  const state = {
    points: 0,
    basePpc: 1,
    ppcMult: 1,
    pps: 0,
    goal: 100000000,
    endless: false,

    prestigePoints: 0,
    totalPrestige: 0,

    upgrades: [],
    producerLevels: {},
    unlockedTiers: {},

    boostEndsAt: 0,
    lastTick: performance.now(),
    schemaVersion: SCHEMA
  };

  const pow = Math.pow;
  function ppcCost(level){
    const base = 50;
    if(level <= 3) return Math.floor(base * pow(1.55, level));
    if(level === 4){
      const prev = Math.floor(base * pow(1.55, 3));
      return prev * 4;
    }
    return Infinity;
  }
  function sizeCost(level){ const base = 350; return Math.floor(base * pow(2.1, level)); }
  function priceProducer(base, n){ return Math.floor(base * Math.pow(1.55, n)); }

  const UPGRADE_DATA = [
    { id:'ppc',  name:'PPC Upgrade', desc:'+1 $/Click (final jumps to $10)', type:'ppc',  max:5,  costFn: ppcCost },
    { id:'size', name:'Target Size', desc:'+10% button size',                type:'size', max:10, costFn: sizeCost }
  ];

  const PRODUCER_TIERS = [
    {
      id: 'tier1',
      name: 'Tier I ‚Äì Cottage & Artisan',
      unlockCost: 0,
      producers: [
        { id:'hand-loom',   name:'Hand Loom Workers',   basePps:0.05, baseCost:200  },
        { id:'blacksmiths', name:'Blacksmith Shops',    basePps:0.15, baseCost:600  },
        { id:'cobblers',    name:'Cobblers',            basePps:0.10, baseCost:400  },
        { id:'print-shops', name:'Small Print Shops',   basePps:0.20, baseCost:900  },
      ]
    },
    {
      id: 'tier2',
      name: 'Tier II ‚Äì Transport & Credit',
      unlockCost: 1,
      producers: [
        { id:'canal-tolls',  name:'Canal Toll Investors',      basePps:0.60, baseCost:4500  },
        { id:'steamboats',   name:'Steamboat Freight Lines',   basePps:1.20, baseCost:9000  },
        { id:'local-banks',  name:'Local Bank Dividends',      basePps:2.50, baseCost:18000 },
        { id:'rr-investors', name:'Railroad Investors',        basePps:4.00, baseCost:30000 },
      ]
    }
  ];

  const QUIZ = [
    {q:'What concept justified U.S. expansion to the Pacific?', c:['Containment','Manifest Destiny','Isolationism','Popular Sovereignty'], a:1},
    {q:'Which war was sparked in part by the annexation of Texas?', c:['Spanish-American War','War of 1812','Mexican‚ÄìAmerican War','Civil War'], a:2},
    {q:"Lincoln's Ten Percent Plan aimed to...", c:['punish Confederates severely','require majority loyalty oaths','offer lenient readmission for states','delay readmission until 1900'], a:2},
    {q:'Which amendment abolished slavery?', c:['13th','14th','15th','16th'], a:0},
    {q:'The Compromise of 1877 resulted in...', c:['renewed Radical Reconstruction','federal troops withdrawn from the South','immediate Black suffrage','annexation of Cuba'], a:1},
  ];

  function save(){
    if(!STORAGE_OK) return;
    try{
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }catch(e){ console.warn('save failed', e); }
  }
  function load(){
    if(!STORAGE_OK) return;
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      Object.assign(state, data);
      if(!data.schemaVersion || data.schemaVersion < SCHEMA){
        migrate();
        state.schemaVersion = SCHEMA;
        save();
      }
    }catch(e){ console.warn('load failed', e); }
  }

  function ensureStructures(){
    if(!Array.isArray(state.upgrades)) state.upgrades = [];
    if(!state.producerLevels || typeof state.producerLevels !== 'object') state.producerLevels = {};
    if(!state.unlockedTiers || typeof state.unlockedTiers !== 'object') state.unlockedTiers = {};
  }

  function migrate(){
    ensureStructures();
    if(state.unlockedTiers['tier1'] === undefined){
      state.unlockedTiers['tier1'] = true;
    }
    applyTargetSizeFromLevel();
    recomputePPS();
  }

  function initContent(){
    ensureStructures();
    if(state.upgrades.length === 0){
      state.upgrades = UPGRADE_DATA.map(u => ({...u, level:0}));
    }
    if(state.unlockedTiers['tier1'] === undefined){
      state.unlockedTiers['tier1'] = true;
    }
    applyTargetSizeFromLevel();
    recomputePPS();
  }

  const moneyEl     = $('#currency');
  const ppcEl       = $('#ppc');
  const ppsEl       = $('#pps');
  const multEl      = $('#mult');
  const prestigeEl  = $('#prestige');
  const progressBar = $('#progressBar');
  const nextGoalEl  = $('#nextGoal');
  const boostTimer  = $('#boostTimer strong');

  const upgradeList     = $('#upgradeList');
  const producerPpsEl   = $('#producerPps');
  const openProducerBtn = $('#openProducerTree');
  const producerModal   = $('#producerModal');
  const producerTreeEl  = $('#producerTree');
  const closeProducerModal = $('#closeProducerModal');

  const clickArea = $('#clickArea');
  const targetBtn = $('#targetBtn');

  const quizModal = $('#quizModal');
  const boostBtn  = $('#boostBtn');
  const closeQuiz = $('#closeQuiz');
  const rerollBtn = $('#rerollBtn');
  const qText     = $('#qText');
  const qChoices  = $('#qChoices');

  const prestigeBtn = $('#prestigeBtn');
  const saveBtn     = $('#saveBtn');

  function fmt(n){
    if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B';
    if(n>=1e6) return '$'+(n/1e6).toFixed(2)+'M';
    if(n>=1e3) return '$'+(n/1e3).toFixed(2)+'k';
    return '$'+Math.floor(n);
  }

  function updateHUD(){
    const multFromPrestige = 1 + (state.prestigePoints || 0);

    moneyEl.textContent = fmt(state.points);
    ppcEl.textContent   = fmt(state.basePpc * state.ppcMult);
    ppsEl.textContent   = '$' + state.pps.toFixed(2);
    multEl.textContent  = multFromPrestige.toFixed(1) + '√ó';
    prestigeEl.textContent = `${state.prestigePoints} pts (√ó${multFromPrestige.toFixed(1)})`;
    producerPpsEl.textContent = '$' + state.pps.toFixed(2);

    const prog = Math.max(0, Math.min(1, state.points / state.goal));
    progressBar.style.width = (prog*100).toFixed(1) + '%';
    nextGoalEl.textContent = state.endless
      ? 'Endless mode unlocked! Keep going. Prestige to earn more prestige points.'
      : `Goal: Reach ${fmt(state.goal)}`;
  }

  function upgradeCost(u){
    return u.type === 'ppc'
      ? ppcCost(u.level)
      : u.type === 'size'
      ? sizeCost(u.level)
      : Infinity;
  }

  function applyTargetSizeFromLevel(){
    const u = (state.upgrades || []).find(x => x.id === 'size');
    const lvl = u?.level || 0;
    const factor = 1 + 0.10 * lvl;
    const px = Math.round(BASE_TARGET_SIZE * factor);
    document.documentElement.style.setProperty('--target-size', px + 'px');
  }

  function buyUpgrade(u){
    if(u.level >= u.max) return;
    const cost = upgradeCost(u);
    if(state.points < cost) return;
    state.points -= cost;

    if(u.type === 'ppc'){
      if(u.level < 4){ state.basePpc += 1; }
      else if(u.level === 4){ state.basePpc += 5; }
      u.level++;
    } else if(u.type === 'size'){
      u.level++;
      applyTargetSizeFromLevel();
    }

    updateHUD();
    renderUpgrades();
    save();
  }

  function renderUpgrades(){
    upgradeList.innerHTML = '';
    state.upgrades.forEach(u => {
      const atMax = u.level >= u.max;
      const cost  = upgradeCost(u);
      const nextLabel = (u.type === 'ppc')
        ? (u.level < 4 ? '+1 $/Click' : (u.level === 4 ? 'Jump to $10/Click' : 'Max'))
        : (u.level < u.max ? '+10% size' : 'Max');

      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="meta">
          <div class="title">${u.name}</div>
          <div class="note">${nextLabel} ‚Ä¢ Owned: ${u.level}/${u.max} ‚Ä¢ ${atMax ? 'MAX' : 'Cost: '+fmt(cost)}</div>
        </div>
      `;

      const btn = document.createElement('button');
      btn.className = 'btn accent';
      btn.textContent = atMax ? 'Maxed' : 'Buy';
      btn.disabled = atMax || state.points < cost;
      btn.addEventListener('click', () => buyUpgrade(u));

      div.appendChild(btn);
      upgradeList.appendChild(div);
    });
  }

  function refreshUpgradeAffordability(){
    $$('#upgradeList .item').forEach((el, i) => {
      const u = state.upgrades[i];
      const atMax = u.level >= u.max;
      const c = upgradeCost(u);
      const note = el.querySelector('.note');
      const nextLabel = (u.type === 'ppc')
        ? (u.level < 4 ? '+1 $/Click' : (u.level === 4 ? 'Jump to $10/Click' : 'Max'))
        : (u.level < u.max ? '+10% size' : 'Max');

      note.textContent = `${nextLabel} ‚Ä¢ Owned: ${u.level}/${u.max} ‚Ä¢ ${atMax ? 'MAX' : 'Cost: '+fmt(c)}`;
      const btn = el.querySelector('button');
      btn.textContent = atMax ? 'Maxed' : 'Buy';
      btn.disabled = atMax || state.points < c;
    });
  }

  function recomputePPS(){
    let total = 0;
    PRODUCER_TIERS.forEach(tier => {
      tier.producers.forEach(p => {
        const lvl = state.producerLevels[p.id] || 0;
        total += p.basePps * lvl;
      });
    });
    state.pps = total;
  }

  function findProducerById(id){
    for(const tier of PRODUCER_TIERS){
      for(const p of tier.producers){
        if(p.id === id) return p;
      }
    }
    return null;
  }

  function buyProducer(prodId){
    const p = findProducerById(prodId);
    if(!p) return;
    let tierId = null;
    PRODUCER_TIERS.forEach(tier => {
      if(tier.producers.some(pp => pp.id === prodId)) tierId = tier.id;
    });
    if(!tierId || !state.unlockedTiers[tierId]) return;

    const level = state.producerLevels[prodId] || 0;
    const cost = priceProducer(p.baseCost, level);
    if(state.points < cost) return;

    state.points -= cost;
    state.producerLevels[prodId] = level + 1;
    recomputePPS();
    renderProducerTree();
    updateHUD();
    save();
  }

  function unlockTier(tierId){
    const tier = PRODUCER_TIERS.find(t => t.id === tierId);
    if(!tier) return;
    if(state.unlockedTiers[tierId]) return;

    const cost = tier.unlockCost || 0;
    const available = state.prestigePoints || 0;
    if(available < cost) return;

    if(!confirm(`Unlock ${tier.name}? This spends ${cost} prestige point(s) and lowers your multiplier.`)) return;

    state.prestigePoints -= cost;
    state.unlockedTiers[tierId] = true;
    recomputePPS();
    renderProducerTree();
    updateHUD();
    save();
  }

  function renderProducerTree(){
    producerTreeEl.innerHTML = '';

    PRODUCER_TIERS.forEach((tier, idx) => {
      const unlocked = !!state.unlockedTiers[tier.id];
      const tierDiv = document.createElement('div');
      tierDiv.className = 'producer-tier';

      const header = document.createElement('div');
      header.className = 'producer-tier-header';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = tier.name;
      const status = document.createElement('div');
      status.className = 'status ' + (unlocked ? 'unlocked' : 'locked');
      status.textContent = unlocked
        ? 'Unlocked'
        : `Locked ‚Äì requires ${tier.unlockCost} prestige point${tier.unlockCost===1?'':'s'}`;
      header.appendChild(title);
      header.appendChild(status);
      tierDiv.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'node-grid';

      // Producer nodes
      tier.producers.forEach(p => {
        const level = state.producerLevels[p.id] || 0;
        const cost  = priceProducer(p.baseCost, level);

        const node = document.createElement('div');
        node.className = 'node';
        node.dataset.producerId = p.id;
        node.dataset.tierId = tier.id;

        const titleEl = document.createElement('div');
        titleEl.className = 'node-title';
        titleEl.textContent = p.name;

        const note = document.createElement('div');
        note.className = 'node-note';
        note.textContent = `+${p.basePps.toFixed(2)} $/s ‚Ä¢ Owned: ${level} ‚Ä¢ Cost: ${fmt(cost)}`;

        const btn = document.createElement('button');
        btn.className = 'btn small-btn';
        btn.textContent = 'Hire';
        btn.disabled = !unlocked || state.points < cost;
        btn.addEventListener('click', () => buyProducer(p.id));

        node.appendChild(titleEl);
        node.appendChild(note);
        node.appendChild(btn);
        grid.appendChild(node);
      });

      // Unlock next tier node
      if(idx < PRODUCER_TIERS.length - 1){
        const nextTier = PRODUCER_TIERS[idx + 1];
        const unlockNode = document.createElement('div');
        unlockNode.className = 'node';
        unlockNode.dataset.unlockTierId = nextTier.id;

        const tTitle = document.createElement('div');
        tTitle.className = 'node-title';
        tTitle.textContent = `Unlock ${nextTier.name}`;

        const nNote = document.createElement('div');
        nNote.className = 'node-note';
        nNote.textContent = `Cost: ${nextTier.unlockCost} prestige point${nextTier.unlockCost===1?'':'s'}`;

        const btn = document.createElement('button');
        btn.className = 'btn small-btn';
        const already = !!state.unlockedTiers[nextTier.id];
        btn.textContent = already ? 'Unlocked' : 'Unlock';
        btn.disabled = already || (state.prestigePoints || 0) < nextTier.unlockCost;
        btn.addEventListener('click', () => unlockTier(nextTier.id));

        unlockNode.appendChild(tTitle);
        unlockNode.appendChild(nNote);
        unlockNode.appendChild(btn);
        grid.appendChild(unlockNode);
      }

      tierDiv.appendChild(grid);
      producerTreeEl.appendChild(tierDiv);
    });
  }

  function updateProducerAffordability(){
    $$('[data-producer-id]').forEach(node => {
      const id = node.dataset.producerId;
      const tierId = node.dataset.tierId;
      const p = findProducerById(id);
      if(!p) return;
      const lvl = state.producerLevels[id] || 0;
      const cost = priceProducer(p.baseCost, lvl);
      const unlocked = !!state.unlockedTiers[tierId];

      const note = node.querySelector('.node-note');
      if(note){
        note.textContent = `+${p.basePps.toFixed(2)} $/s ‚Ä¢ Owned: ${lvl} ‚Ä¢ Cost: ${fmt(cost)}`;
      }
      const btn = node.querySelector('button');
      if(btn){
        btn.disabled = !unlocked || state.points < cost;
      }
    });

    $$('[data-unlock-tier-id]').forEach(node => {
      const tierId = node.dataset.unlockTierId;
      const tier   = PRODUCER_TIERS.find(t => t.id === tierId);
      if(!tier) return;
      const cost = tier.unlockCost || 0;
      const already = !!state.unlockedTiers[tierId];
      const btn = node.querySelector('button');
      const note = node.querySelector('.node-note');
      if(note){
        note.textContent = `Cost: ${cost} prestige point${cost===1?'':'s'}`;
      }
      if(btn){
        btn.disabled = already || (state.prestigePoints || 0) < cost;
        btn.textContent = already ? 'Unlocked' : 'Unlock';
      }
    });
  }

  function checkGoal(){
    if(state.points >= state.goal){
      if(state.goal >= 100000000){
        state.endless = true;
      } else {
        state.goal = Math.floor(state.goal * 2.7);
      }
    }
  }

  function moveTarget(){
    const a = clickArea.getBoundingClientRect();
    const s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--target-size')) || BASE_TARGET_SIZE;
    const p = 10;
    const x = p + Math.random() * Math.max(0, a.width  - s - p);
    const y = p + Math.random() * Math.max(0, a.height - s - p);
    targetBtn.style.left = x + 'px';
    targetBtn.style.top  = y + 'px';
  }
  new ResizeObserver(() => moveTarget()).observe(clickArea);

  targetBtn.addEventListener('click', () => {
    const mult = 1 + (state.prestigePoints || 0);
    const gain = state.basePpc * state.ppcMult * mult;
    state.points += gain;
    checkGoal();
    updateHUD();
    refreshUpgradeAffordability();
    updateProducerAffordability();
    moveTarget();
    save();
  });
  targetBtn.addEventListener('keydown', e => {
    if(e.key === ' ' || e.key === 'Enter'){
      e.preventDefault();
      targetBtn.click();
    }
  });

  let currentQ = null;
  let rewarded = false;

  function pickQuestion(){
    currentQ = QUIZ[Math.floor(Math.random()*QUIZ.length)];
    rewarded = false;
    qText.textContent = currentQ.q;
    qChoices.innerHTML = '';
    currentQ.c.forEach((text, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'choice';
      btn.innerHTML = `<span class="pill">${String.fromCharCode(65+idx)}</span> <span>${text}</span>`;
      btn.addEventListener('click', () => handleAnswer(idx, btn));
      qChoices.appendChild(btn);
    });
  }

  function handleAnswer(idx, el){
    if(rewarded) return;
    const correct = idx === currentQ.a;
    $$('.choice').forEach(b => b.disabled = true);
    if(correct){
      el.classList.add('correct');
      showRewardChooser();
      rewarded = true;
    } else {
      el.classList.add('wrong');
      const msg = document.createElement('div');
      msg.className = 'small';
      msg.style.marginTop = '8px';
      msg.textContent = 'Not quite. Reroll or close and try again.';
      qChoices.appendChild(msg);
    }
  }

  function showRewardChooser(){
    const wrap = document.createElement('div');
    wrap.style.marginTop = '12px';
    wrap.innerHTML = `<div class="small">Nice! Pick your reward:</div>`;
    const row = document.createElement('div');
    row.className = 'row';
    row.style.marginTop = '8px';
    const r1 = document.createElement('button');
    r1.className = 'btn gold';
    r1.textContent = '2√ó $/Click for 60s';
    const r2 = document.createElement('button');
    r2.className = 'btn accent';
    r2.textContent = 'Free cheapest upgrade';

    r1.addEventListener('click', () => { startBoost(60); quizModal.close(); });
    r2.addEventListener('click', () => { grantFreeUpgrade(); quizModal.close(); });

    row.appendChild(r1);
    row.appendChild(r2);
    wrap.appendChild(row);
    qChoices.appendChild(wrap);
  }

  function startBoost(seconds){
    state.ppcMult = 2;
    state.boostEndsAt = performance.now() + seconds * 1000;
    boostTimer.textContent = seconds + 's';
    updateHUD();
    save();
  }

  function grantFreeUpgrade(){
    const candidates = state.upgrades
      .filter(u => u.level < u.max)
      .map(u => ({u, cost: upgradeCost(u)}))
      .sort((a,b) => a.cost - b.cost);
    if(!candidates.length) return;
    const chosen = candidates[0].u;
    if(chosen.type === 'ppc'){
      if(chosen.level < 4){ state.basePpc += 1; }
      else if(chosen.level === 4){ state.basePpc += 5; }
      chosen.level++;
    } else if(chosen.type === 'size'){
      chosen.level++;
      applyTargetSizeFromLevel();
    }
    renderUpgrades();
    updateHUD();
    save();
  }

  boostBtn.addEventListener('click', () => { pickQuestion(); quizModal.showModal(); });
  closeQuiz.addEventListener('click', () => quizModal.close());
  rerollBtn.addEventListener('click', pickQuestion);

  function canPrestige(){
    return state.points >= 100000000 || state.endless;
  }

  function doPrestige(){
    if(!canPrestige()) return;
    if(!confirm('Prestige? Reset money and upgrades to gain +1 prestige point (stacking multiplier from unspent points).')) return;
    state.totalPrestige = (state.totalPrestige || 0) + 1;
    state.prestigePoints = (state.prestigePoints || 0) + 1;

    state.points = 0;
    state.basePpc = 1;
    state.ppcMult = 1;
    state.pps = 0;
    state.boostEndsAt = 0;
    state.endless = false;
    state.goal = 100000000;

    state.upgrades.forEach(u => u.level = 0);
    state.producerLevels = {};

    applyTargetSizeFromLevel();
    recomputePPS();
    renderUpgrades();
    renderProducerTree();
    updateHUD();
    moveTarget();
    save();
  }
  prestigeBtn.addEventListener('click', doPrestige);

  openProducerBtn.addEventListener('click', () => {
    renderProducerTree();
    producerModal.showModal();
  });
  closeProducerModal.addEventListener('click', () => producerModal.close());

  saveBtn.addEventListener('click', () => {
    save();
    const note = document.createElement('span');
    note.textContent = ' Saved!';
    note.className = 'pill';
    note.style.marginLeft = '8px';
    note.style.opacity = '0.9';
    saveBtn.after(note);
    setTimeout(() => note.remove(), 1200);
  });

  function tick(){
    const now = performance.now();
    const dt = Math.min(1, (now - state.lastTick) / 1000);
    state.lastTick = now;

    const mult = 1 + (state.prestigePoints || 0);
    state.points += state.pps * dt * mult;

    if(state.boostEndsAt > 0){
      const remaining = Math.max(0, Math.ceil((state.boostEndsAt - now)/1000));
      boostTimer.textContent = remaining ? (remaining + 's') : '‚Äî';
      if(!remaining){
        state.ppcMult = 1;
        state.boostEndsAt = 0;
      }
    }

    checkGoal();
    updateHUD();
    refreshUpgradeAffordability();
    updateProducerAffordability();
    requestAnimationFrame(tick);
  }

  load();
  initContent();
  migrate();
  renderUpgrades();
  renderProducerTree();
  updateHUD();
  moveTarget();

  if(STORAGE_OK){
    setInterval(save, 15000);
    window.addEventListener('beforeunload', save);
    document.addEventListener('visibilitychange', () => { if(document.hidden) save(); });
  }

  requestAnimationFrame(tick);
  window.__state = state;
});
</script>
</body>
</html>
